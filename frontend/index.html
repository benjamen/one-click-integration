<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Initialize window.frappe BEFORE any scripts load (including Vite client) -->
    <!-- This prevents "Cannot read properties of undefined" errors from frappe-ui -->
    <script>
      // Complete Frappe Framework shim for standalone frappe-ui
      // This MUST run before any other scripts (including Vite client)
      ;(function() {
        if (window.frappe) {
          console.log('[Frappe Shim - index.html] window.frappe already exists, skipping')
          return
        }

        console.log('[Frappe Shim - index.html] Initializing window.frappe...')

        window.frappe = {
          _messages: {},
          boot: { lang: 'en', sysdefaults: {}, user: {} },
          csrf_token: null,
          datetime: {},
          form: {},
          listview_settings: {},
          model: {
            docinfo: {},
            get_docinfo: function() { return {} },
            get_value: function() { return Promise.resolve() },
            set_value: function() { return Promise.resolve() },
          },
          pages: {},
          provide: function() {},
          require: function() { return Promise.resolve() },
          route_options: null,
          templates: {},
          ui: {
            ScriptManager: function() {
              this.load = function() { return Promise.resolve() }
              this.loaded = {}
            },
            FieldGroup: function() {},
            Dialog: function() {},
            form_builders: {},
            toolbar: {},
          },
          utils: {
            get_url_arg: function() { return null },
            get_query_params: function() { return {} },
          },
          call: function() { return Promise.resolve({ message: {} }) },
          xcall: function() { return Promise.resolve() },
          db: {
            get_value: function() { return Promise.resolve() },
            get_list: function() { return Promise.resolve([]) },
          },
        }
        window.site_name = 'lodgeick.com'
        window.cur_frm = null
        window.cur_list = null
        window.cur_dialog = null

        console.log('[Frappe Shim - index.html] Initialized successfully')
        console.log('[Frappe Shim - index.html] frappe.ui:', window.frappe.ui)
        console.log('[Frappe Shim - index.html] frappe.ui.ScriptManager:', window.frappe.ui.ScriptManager)

        // Monitor frappe object for complete replacement using a Proxy
        var originalFrappe = window.frappe;
        Object.defineProperty(window, 'frappe', {
          get: function() {
            if (!originalFrappe || !originalFrappe.ui || !originalFrappe.ui.ScriptManager) {
              console.error('[Frappe Shim] CRITICAL: window.frappe has been corrupted!', originalFrappe)
              console.trace('[Frappe Shim] Stack trace:')
              // Restore it immediately
              originalFrappe = {
                _messages: {},
                boot: { lang: 'en', sysdefaults: {}, user: {} },
                csrf_token: null,
                datetime: {},
                form: {},
                listview_settings: {},
                model: {
                  docinfo: {},
                  get_docinfo: function() { return {} },
                  get_value: function() { return Promise.resolve() },
                  set_value: function() { return Promise.resolve() },
                },
                pages: {},
                provide: function() {},
                require: function() { return Promise.resolve() },
                route_options: null,
                templates: {},
                ui: {
                  ScriptManager: function() {
                    this.load = function() { return Promise.resolve() }
                    this.loaded = {}
                  },
                  FieldGroup: function() {},
                  Dialog: function() {},
                  form_builders: {},
                  toolbar: {},
                },
                utils: {
                  get_url_arg: function() { return null },
                  get_query_params: function() { return {} },
                },
                call: function() { return Promise.resolve({ message: {} }) },
                xcall: function() { return Promise.resolve() },
                db: {
                  get_value: function() { return Promise.resolve() },
                  get_list: function() { return Promise.resolve([]) },
                },
              }
            }
            return originalFrappe;
          },
          set: function(newValue) {
            console.warn('[Frappe Shim] WARNING: Something is trying to overwrite window.frappe!', newValue)
            console.trace('[Frappe Shim] Stack trace of setter:')
            // Merge new properties but preserve critical ones
            if (newValue && typeof newValue === 'object') {
              Object.assign(originalFrappe, newValue);
              // Ensure ui.ScriptManager is never lost
              if (!originalFrappe.ui || !originalFrappe.ui.ScriptManager) {
                console.error('[Frappe Shim] Restoring ui.ScriptManager after attempted overwrite')
                originalFrappe.ui = {
                  ScriptManager: function() {
                    this.load = function() { return Promise.resolve() }
                    this.loaded = {}
                  },
                  FieldGroup: function() {},
                  Dialog: function() {},
                  form_builders: {},
                  toolbar: {},
                }
              }
            } else {
              originalFrappe = newValue;
            }
          },
          configurable: false
        });

        console.log('[Frappe Shim - index.html] Protection enabled for window.frappe')
      })()
    </script>

    <meta charset="UTF-8" />
    <link rel="icon" href="/favicon.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lodgeick - One-Click Integrations</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  </head>
  <body>
    <div id="app"></div>
    <script type="module" src="/src/main.js"></script>
  </body>
</html>
